name: K6 - Testes de Performance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  performance-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Gerar Timestamp
      id: date
      run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV

    - name: Instalar dependências
      run: npm ci

    - name: Baixar k6
      run: |
        curl -L https://github.com/grafana/k6/releases/download/v0.51.0/k6-v0.51.0-linux-amd64.tar.gz -o k6.tar.gz
        tar -xzf k6.tar.gz
        sudo mv k6-v0.51.0-linux-amd64/k6 /usr/local/bin/

    - name: Iniciar Servidor REST
      run: |
        npm run start:rest &
        echo "Aguardando servidor iniciar..."

    - name: Aguardar disponibilidade das APIs
      run: |
        for i in {1..30}; do
          curl -s http://localhost:3000/api-docs > /dev/null && echo "Servidor pronto!" && exit 0
          echo "Aguardando... ($i/30)"
          sleep 2
        done
        echo "Servidor não iniciou a tempo."
        exit 1

    - name: Executar Suite de Performance (k6)
      env:
        K6_WEB_DASHBOARD: "true"
        K6_WEB_DASHBOARD_EXPORT: "k6-report-${{ env.TIMESTAMP }}.html"
      run: k6 run tests/k6/load_test_suite.js

    - name: Upload Relatório de Performance
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: k6-performance-report-${{ env.TIMESTAMP }}
        path: k6-report-${{ env.TIMESTAMP }}.html
